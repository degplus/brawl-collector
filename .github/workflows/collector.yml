name: Brawl Stars Collector

on:
  schedule:
    # Escolha UMA opção abaixo (deixe as outras comentadas):
    
    # - cron: '*/30 * * * *'  # A cada 30 minutos (torneios)
    # - cron: '*/45 * * * *'    # A cada 45 minutos (padrão) ✅
    # - cron: '0 * * * *'     # A cada 1 hora (economia)
    # - cron: '0 */2 * * *'   # A cada 2 horas (máxima economia)
     - cron: '*/3 * * * *'   # A cada 3 minutos (CUIDADO: uso alto!)
    
  workflow_dispatch:  # Execução manual


concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  collect:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Run collector
        env:
          BRAWL_API_TOKEN: ${{ secrets.BRAWL_API_TOKEN }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: python main.py

      # ✅ NOVO PASSO: Atualiza tabela de filtros do dashboard
      - name: Update dim_filters
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: python update_dim_filters.py
